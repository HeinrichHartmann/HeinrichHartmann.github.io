<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
   <title>Monitoring With Ganglia</title>
   <meta name="author" content="Heinrich Hartmann"/>

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css"/>

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection"/>

   <!-- RSS feed -->
   <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

   <!-- Favicon -->
   <link rel="icon" type="image/png" href="/images/favicon.png">

   
   </head>
<body>

<div class="site">
  <div class="title">
    <a href="/">Heinrich Hartmann</a>
    <a class="extra" href="/opinion.html">opinion</a>
    <a class="extra" href="/consulting.html">consulting</a>
    <a class="extra" href="/about.html">about</a>
    <div class="social" style='float:right'>
      <!-- <div style='float:right'> -->
      <!--   <a href="http://eepurl.com/ccmH-T"><img src="/images/mail_icon.svg" width="25px"/></a> -->
      <!-- </div> -->
      <div style='float:right'>
        <a href="/feed.xml"><img src="/images/rss_icon.svg" width="25px" style="margin: 0 10px 0 0;"/></a>
      </div>
      <div style='float:right'>
        <a href="http://twitter.com/intent/follow?screen_name=HeinrichHartman"><img src="/images/twitter_icon.svg" width="25px" style="margin: 0 10px 0 0;"></a>
      </div>
    </div>
  </div>
  

  <div id="post">

  <!-- Title -->
  <h1> Monitoring With Ganglia</h1>

  


  <!-- Meta -->
  <p class="meta">
    Written on 2014-01-01
    
    
  </p>

  <!-- Splash -->
  

  <!-- Post content -->
  <!-- # Ganglia -->

<p>In this note we are going to install the Ganglia monitoring system on
a Virtual Cluster.</p>

<p>Gangila was initially developed at UBerkley. Is free software. It
scales to multiple nodes and multiple clusters. Oreilly has a book on
it.</p>

<h2 id="architecture">Architecture</h2>
<p>Ganglia consists of three different services <code class="highlighter-rouge">gmond</code>, <code class="highlighter-rouge">gmetad</code> and <code class="highlighter-rouge">gweb</code>.</p>

<ul>
  <li><code class="highlighter-rouge">gmond</code><br />
lightweight process that monitors system ressources and broadcast
them on the local subnet.  Also it receives broadcast messages from
the neihbouring nodes and makes them accessible for polling by
<code class="highlighter-rouge">gmetad</code>.  It is important to note, that only the current state is
rembered by the <code class="highlighter-rouge">gmond</code> instances and no historical data.</li>
  <li><code class="highlighter-rouge">gmetad</code><br />
Service that aggregates status information from multiple
clusters. Per cluster it is sufficient to poll <strong>one</strong> <code class="highlighter-rouge">gmond</code>
instance, since the state is shared among the nodes.</li>
  <li><code class="highlighter-rouge">gweb</code><br />
 web dashboard for <code class="highlighter-rouge">gmetad</code> nodes.</li>
</ul>

<p>Architecture Scetch</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     gmond                gmetad      gweb
     =====                ======      ====
  * &lt;-----&gt; * &lt;---[poll]---&gt; * &lt;-------&gt; *
  | Cluster |                |
  * &lt;-----&gt; *                |
                             |
  * &lt;-----&gt; * &lt;---[poll]-----+
  | Cluster |
  * &lt;-----&gt; *
</code></pre></div></div>

<h3 id="gmond">gmond</h3>

<ul>
  <li>Gathers data from local system on an independent schedule.</li>
  <li>Implication: System does not rely on external polling. Many
independent poller can queery the cluster. E.g. <code class="highlighter-rouge">gmond-zeromq</code>
publishes data on zmq bus.</li>
  <li>gmond seems to run single threaded: (cf. <code class="highlighter-rouge">ps -eLf | grep gmond</code>)</li>
  <li>Can be extended to report metrics provided by scripts in any
language. Especially easy: C, C++, Python. <code class="highlighter-rouge">gmetric</code> tool provided.</li>
  <li>
    <p>Metics are shared between gmond nodes via <a href="http://en.wikipedia.org/wiki/IP_multicast">multicast channels</a></p>
  </li>
  <li>Configuration in <code class="highlighter-rouge">/etc/ganglia/gmond.conf</code>
    <ul>
      <li>Configure multicast channels</li>
      <li>Add customized metrics. (modified by <code class="highlighter-rouge">gmetric</code> tool)</li>
    </ul>
  </li>
</ul>

<h3 id="gmetad">gmetad</h3>

<ul>
  <li>Polls the gmond daemons for data.</li>
  <li>Stores historic data in RoundRobin Database</li>
  <li>Provides raw data for web interface</li>
</ul>

<h1 id="install-software">Install software</h1>

<h2 id="gangila-monitor">Gangila Monitor</h2>
<p>Installation via apt-get is a piece of cake:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh VLB1 sudo apt-get install ganglia-monitor
</code></pre></div></div>

<p>Now start the monitor daemon:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh VLB1 sudo service ganglia-monitor start
</code></pre></div></div>

<p>and test it is collecting metrics by typing in:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc VLB1 8649
</code></pre></div></div>

<p>You should see an XML dump of the metrics in your terminal window.</p>

<h2 id="gangila-meta-daemon">Gangila Meta Daemon</h2>

<p>We install the <code class="highlighter-rouge">gemetad</code> and the web frontend on the host machine</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> sudo apt-get install gmetad
</code></pre></div></div>

<p>Now start the <code class="highlighter-rouge">gmetad</code> daemon by running</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo service gemtad start
</code></pre></div></div>

<p>Test its functionality by running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc localhost 8651
</code></pre></div></div>

<p>it should respond with an XML representing the state of all connected
nodes (i.e. none).</p>

<p>To get more elaborate information about the meta daemon run it from
the command line with enabled debug information:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -u nobody gmetad --debug=10
</code></pre></div></div>

<h2 id="ip-multicast-setup">IP Multicast Setup</h2>

<p>Ganglia uses multicast channels to connect different gmond daemons
with each other.</p>

<p>It seems surprisingly difficult to get install and test multicast
networking.  First we need to check if multicast is supported by your
kernel (should be) following
<a href="http://unix.stackexchange.com/questions/25872/how-can-i-know-if-ip-multicast-is-enabled">Stackexchange</a>
one can use:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip maddr show
cat /proc/net/igmp
netstat -ng
</code></pre></div></div>

<p>to display information about the multicast configuration.  Another
very helpful source http://sorcersoft.org/resources/notes/multicast.html</p>

<p>We make sure the mutlicast packages are sent over the right ethernet
interface by adding the following route:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh VLB1 sudo route add -net 224.0.0.0 netmask 240.0.0.0 dev eth0
ssh VLB2 sudo route add -net 224.0.0.0 netmask 240.0.0.0 dev eth0
</code></pre></div></div>

<h2 id="ganglia-web-frontend">Ganglia Web Frontend</h2>

<p>Ganglia provides a nice php web-site that visualizes the data
aggregated by <code class="highlighter-rouge">gmetad</code>. Installation and start of the application
are rather easy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install ganglia-webfrontend
sudo cp /etc/ganglia/apache.conf /etc/apache2/sites-enabled/ganglia
sudo service apache2 reload
</code></pre></div></div>

<p>Remark: The apache.conf file is a single line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias /ganglia /usr/share/ganglia-webfrontend
</code></pre></div></div>

<p>Now, you should be able to open the webfrontend by opening the url:
 http://localhost/ganglia on your host machine.</p>

<h1 id="configuration">Configuration</h1>

<h1 id="gangila-monitor-1">Gangila Monitor</h1>

<p>We have two virtual nodes VLB1 and VLB2 running <code class="highlighter-rouge">gmond</code> daemon and
share their metrics on a multicast channel over the virtual network.
To make <code class="highlighter-rouge">gmetad</code> aware of those nodes edit the
<code class="highlighter-rouge">/etc/ganglia/gmetad.conf</code> to contain the following line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> data_source "Virtual Cluster" 1 VLB1 VLB2
</code></pre></div></div>

<p>Now restart the gemtad daemon, eg. using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> sudo service gmetad restart
</code></pre></div></div>

<p>and you should be able to see two virtual machines in the web
frontend.</p>

<h1 id="debugging">Debugging</h1>

<p>Odds are, that something went wrong along the way, to get a better
understanding of the problem start the daemons from the command line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> sudo -u nobody gmetad -d 10

 # on the VMs
 sudo gmetad -d 10
</code></pre></div></div>

<h1 id="extensions">Extensions</h1>

<p>There are two different ways to extend ganglia by customized metrics.</p>

<ol>
  <li>Using <code class="highlighter-rouge">gmetric</code> tool</li>
  <li>Including modules in C/C++</li>
  <li>Including modules in Python (via mod_python module)</li>
</ol>

<p>The gmetric tool allow to set specific values to metrics:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gmetric --name="my_metric" --value="18" --type=int32
</code></pre></div></div>

<p>It does not, however, allow the repeated execution of a specific
script scheduled by the <code class="highlighter-rouge">gmond</code> daemon but has to be triggered by an
extrenal process like <code class="highlighter-rouge">cron</code>.</p>

<h2 id="crontab">Crontab</h2>

<p>We can add the following line in <code class="highlighter-rouge">crontab -e</code> to monitor the size of
your <code class="highlighter-rouge">www</code> folder every minute</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># m h dom mon dow command
* * * * * gmetric --name="size_www" --type=int32 --value=`du -s /var/www | cut -f1`
</code></pre></div></div>

<p>To see, if this script is executed use</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -f /var/log/syslog | grep CRON
</code></pre></div></div>

<p>You should see messages like</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dec 27 12:51:01 VLB CRON[4136]: (user) CMD (gmetric --name="size_www" --type=int32 --value=`du -s /var/www | cut -f1`)
</code></pre></div></div>

<p>appear every minute. If another line</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dec 27 12:57:01 VLB CRON[4297]: (CRON) info (No MTA installed, discarding output)
</code></pre></div></div>

<p>appears next to it, then something went wrong.</p>

<h3 id="catches">Catches</h3>

<ul>
  <li>
    <p>Crontab uses a different execution environment, then the login
shell. To test the environment use something like:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  * * * * * env &gt; ~/cron-env.txt
</code></pre></div>    </div>

    <p>In my case cron was using a different shell (<code class="highlighter-rouge">dash</code>) and the path
variable did not contain the current directory (“.”). Therefore
environment variables (like $RANDOM) were not working as intended and
I as not able to run scripts in my home directory directly.</p>
  </li>
  <li>
    <p>Crontab sends stdout and stderr of the scripts via email. If you
dont have an MTA like <code class="highlighter-rouge">postfix</code> installed, you will not be able to
see the output of your scripts. Solution:</p>
    <ul>
      <li>install an MTA</li>
      <li>redirect output to a log file by appending <code class="highlighter-rouge">2&gt;&amp;1 &gt;&gt; ~/cron.log</code> to
the crontab line.</li>
    </ul>
  </li>
</ul>

<h3 id="current-setup">Current Setup</h3>

<p>My crontab has a single entry that runs a script</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># m h dom mon dow command
* * * * * ~/ganglia-metrics.sh 2&gt;&amp;1 &gt;&gt; ~/crontab.log
</code></pre></div></div>

<p>Note, that the script is called using it’s full path and the output is
redirected to a log file. The <code class="highlighter-rouge">ganglia-metrics.sh</code> script looks as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">GMETRIC</span><span class="o">=</span>/usr/bin/gmetric

<span class="nb">echo</span> <span class="sb">`</span>date<span class="sb">`</span> <span class="s2">"- executing ganglia-metrics.sh"</span>

<span class="nv">$GMETRIC</span> <span class="nt">--name</span><span class="o">=</span><span class="s2">"size_www"</span> <span class="nt">--type</span><span class="o">=</span>int32 <span class="nt">--value</span><span class="o">=</span><span class="sb">`</span>du <span class="nt">-s</span> /var/www | cut <span class="nt">-f1</span><span class="sb">`</span>

<span class="c"># some more dummy metrics ...</span>
<span class="nv">$GMETRIC</span> <span class="nt">--name</span><span class="o">=</span><span class="s2">"date"</span> <span class="nt">--type</span><span class="o">=</span>int32 <span class="nt">--value</span><span class="o">=</span><span class="sb">`</span>date +%s<span class="sb">`</span>
<span class="nv">$GMETRIC</span> <span class="nt">--name</span><span class="o">=</span><span class="s2">"rand"</span> <span class="nt">--type</span><span class="o">=</span>int32 <span class="nt">--value</span><span class="o">=</span><span class="nv">$RANDOM</span>
</code></pre></div></div>

<p>Note, that the script uses a shebang ‘#!’ in order to be executed by
the bash shell.</p>

<p>More examples can be found on <a href="https://github.com/ganglia/gmetric">github</a>.
See <a href="https://github.com/vvuksan/ganglia-misc/tree/master/gmetric-python">https://github.com/vvuksan/ganglia-misc/tree/master/gmetric-python</a> for a python implementation of gmetric.</p>

<h2 id="python-modules">Python modules</h2>

<p>Ganglia can be extended by python modules. In contrast to the gmetric
method explained before, these python modules are executed by gmond
and do not have to be scheduled by a cron job.</p>

<p>To enable python modules one has to load the python module wrapper as
a module. You can see all installed native-modules using:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls -l /usr/lib/ganglia
</code></pre></div></div>

<p>Unfortunately the preinstalled <code class="highlighter-rouge">gmond.conf</code> version does not include a
configuration template, even though the <code class="highlighter-rouge">modpython.so</code> file is
provided. We have to add the following lines into <code class="highlighter-rouge">gmond.conf</code>
(cf. <a href="https://bugs.launchpad.net/ubuntu/+source/ganglia/+bug/694208">https://bugs.launchpad.net/ubuntu/+source/ganglia/+bug/694208</a>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>modules {
    module {
       name = "python_module"
       path = "/usr/lib/ganglia/modpython.so"
       params = "/usr/lib/ganglia/python_modules"
    }
}

include ('/etc/ganglia/conf.d/*.pyconf')
</code></pre></div></div>

<p>Now run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mkdir -p /usr/lib/ganglia/python_modules /etc/ganglia/conf.d
</code></pre></div></div>

<p>to create the directories if necessary. Use</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo gmond -m -d 10
</code></pre></div></div>

<p>to verify the module is loaded correctly. (You shoud see <code class="highlighter-rouge">loaded
module: python_module</code> at the beginnig followed by no error messages).</p>

<h2 id="install-example-python-metric">Install example python metric</h2>

<p>Before we write our own python metric we install the ‘disk_free’
metric from <a href="https://github.com/ganglia/gmond_python_modules">github</a>
by <a href="https://github.com/vvuksan">Vladimir Vuksan</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://raw.github.com/ganglia/gmond_python_modules/master/diskfree/python_modules/diskfree.py \
     | sudo tee /usr/lib/ganglia/python_modules/diskfree.py
curl https://raw.github.com/ganglia/gmond_python_modules/master/diskfree/conf.d/diskfree.pyconf \
     | sudo tee /etc/ganglia/conf.d/diskfree.pyconf
</code></pre></div></div>

<p>Check that everything was is working fine by running, e.g.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo gmond -m -d 10 | grep disk_free
</code></pre></div></div>

<p>Start <code class="highlighter-rouge">gmond</code> again and you should see disk_free metrics in the web interface.</p>

<h2 id="write-our-own-module">Write our own module</h2>

<p>Now, that we know the python module infrastructure works as expected,
lets write our own:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF | sudo tee /usr/lib/ganglia/python_modules/example.py
#!/usr/bin/env python
# -*- coding: utf-8 -*-

def get_value(name):
    """Return a value for the requested metric"""
    return 17
    
def metric_init(lparams):
    """Initialize metric descriptors"""

    # create descriptors
    descriptors = []

    descriptors.append({
        'name': "example",
        'call_back': get_value,
        'time_max': 60,
        'value_type': 'float',
        'units': '%',
        'slope': 'both',
        'format': '%f',
        'description': "example metric",
        'groups': 'example'
    })

    return descriptors

def metric_cleanup():
    """Cleanup"""
    pass

# the following code is for debugging and testing
if __name__ == '__main__':
    descriptors = metric_init({})
    for d in descriptors:
        print (('%s = %s') % (d['name'], d['format'])) % (d['call_back'](d['name']))
EOF
</code></pre></div></div>

<p>save this script in your python modules directory and test its
functionality using:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> python /usr/lib/ganglia/python_modules/example.py
</code></pre></div></div>

<p>Now add the python module to gmond configuration using e.g.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF | sudo tee /etc/ganglia/conf.d/example.pyconf
modules {
    module {
        name = "example"
        language = "python"
    }
}

collection_group {
    collect_every = 10
    time_threshold = 180
    metric {
       name_match = "example"
    }
}
EOF
</code></pre></div></div>

<p>For more information see the
<a href="http://sourceforge.net/apps/trac/ganglia/wiki/ganglia_gmond_python_modules">official docs</a>.</p>


  <!-- Comments -->
  
    <em>Comments have been disabled until the dust around the GDPR settled.</em>
    <!-- <div id="disqus_thread"></div> -->
    <!-- <script type="text/javascript"> -->
    <!--   /* * * CONFIGURATION VARIABLES * * */ -->
    <!--   var disqus_shortname = 'heinrichhartmann'; -->
    <!--   /* * * DON'T EDIT BELOW THIS LINE * * */ -->
    <!--   (function() { -->
    <!--   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; -->
    <!--   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; -->
    <!--   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); -->
    <!--   })(); -->
    <!-- </script> -->
    <!-- <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments</a></noscript> -->
  

</div>


  <div class="footer">
    <div class="contact">
      <p>
        Licensed under <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC-BY 4.0.</a>
        <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title" style="display:none">This blog</span>
        <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName" style="display:none">Heinrich Hartmann</span>
      </p>
    </div>
  </div>
</div>



<!-- Google Analytics -->

<!-- <script> -->
<!--   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ -->
<!--   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), -->
<!--   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) -->
<!--   })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); -->

<!--   ga('create', 'UA-53959000-1', 'auto'); -->
<!--   ga('send', 'pageview'); -->
<!-- </script> -->

</body>
</html>
