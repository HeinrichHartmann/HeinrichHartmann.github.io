<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
   <title>Setting Up A Virtual Cluster</title>
   <meta name="author" content="Heinrich Hartmann"/>

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css"/>

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection"/>

   <!-- RSS feed -->
   <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

   <!-- Favicon -->
   <link rel="icon" type="image/png" href="/images/favicon.png">
   </head>
<body>

<div class="site">
  <div class="title">
    <a href="/">Heinrich Hartmann</a>
    <a class="extra" href="/opinion.html">opinion</a>
    <a class="extra" href="/consulting.html">consulting</a>
    <a class="extra" href="/about.html">about</a>
    <div style='float:right'>
      <a href="http://eepurl.com/ccmH-T"><img src="/images/mail_icon.svg" width="25px"/></a>
    </div>
    <div style='float:right'>
      <a href="/feed.xml"><img src="/images/rss_icon.svg" width="25px" style="margin: 0 10px 0 0;"/></a>
    </div>
    <div style='float:right'>
      <a href="http://twitter.com/intent/follow?screen_name=HeinrichHartman"><img src="/images/twitter_icon.svg" width="25px" style="margin: 0 10px 0 0;"></a>
    </div>
  </div>

  <div id="post">

  <!-- Title -->
  <h1> Setting Up A Virtual Cluster</h1>

  

  <!-- Meta -->
  <p class="meta">
    Written on 2013-12-25
    
  </p>

  <!-- Splash -->
  

  <!-- Post content -->
  <!-- # Virtual Cluster -->

<p>When playing around with distributed technologies like hadoop or
databases, it becomes at some point important to have a number of
machines available to perform tests in a truly distributed
environment. In this note I am going to explain how to setup a virtual
cluster using virtual box, so that you can simulate such an environment
on a single laptop.</p>

<h2 id="target-network-configuration">Target Network Configuration</h2>

<p>Each host has two network interfaces.</p>

<ul>
  <li>Adapter 1: Host Only Interface. This is a virtual network used to
connect the virtual hosts and the physical host system.</li>
  <li>Adapter 2: NAT. Used to connect the virtual hosts to the internet.</li>
</ul>

<p>Network Setup Sketch:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                     vboxnet0  inet
					 
                              [GW]
 HOST:                          |
      [wlan0|auto,NAT]----------+
      [vboxnet0|.1]-----+       |
                        |       |
 VLB1:                  |       |
      [eth0|auto]-------|-------+
      [eth1|.101]-------+       |
                        |       |
 VLB2:                  |       |
 	  [eth0|auto]-------|-------+
      [eth1|.102]-------+
</code></pre></div></div>

<h2 id="vm-setup">VM Setup</h2>

<ol>
  <li>Create a new virtual machine<br />
I used the following specs:
    <ul>
      <li>1Gb Memory</li>
      <li>5Gb Disk (dynamically allocated)</li>
      <li>two network adapters as described above.</li>
    </ul>
  </li>
  <li>Install linux.<br />
I used Ubuntu 12.04 Server.
Update packages and install basic tools (e.g. <code class="highlighter-rouge">openssh, emacs</code>)</li>
  <li>Network configuration<br />
Enable dhcp on both network interfaces in <code class="highlighter-rouge">/etc/network/interfaces</code>.</li>
  <li>
    <p>Setup ssh access.<br />
I like to be able to get a remote shell by simply typing <code class="highlighter-rouge">ssh &lt;hostname&gt;</code>.
Use <code class="highlighter-rouge">.ssh/config</code> to set the default user name (user), and copy the ssh key
as described e.g. at https://help.ubuntu.com/community/SSH/OpenSSH/</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cat ~/.ssh/id_rsa.pub | ssh VLB "cat &gt;&gt; .ssh/authorized_keys"
</code></pre></div>    </div>
  </li>
</ol>

<p>Excerpt from <code class="highlighter-rouge">/etc/network/interfaces</code> on the virtual hosts:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet dhcp
</code></pre></div></div>

<p>Excerpt from <code class="highlighter-rouge">~/.ssh/config</code> on the hosts:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host VLB
HostName 192.168.56.101
User user
</code></pre></div></div>

<h2 id="cloning">Cloning</h2>

<p>Before shutting down the root VM for cloning execute the following
command on the shell:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo rm -f /etc/udev/rules.d/70-persistent-net.rules
</code></pre></div></div>

<p>This will erase the network card configuration.  Now shutdown the VM
and clone the virtual machine in virtual box. Select ‘Reinitialize the
MAC addresses of all network cards’.</p>

<p>We need different mac addresses to have both cards in the same
network. As a result the linux kernel will detect the network cards as
new interfaces and give them new names (<code class="highlighter-rouge">eth1</code>, <code class="highlighter-rouge">eth2</code>) - and not be
automatically activated and configured on boot.</p>

<h2 id="hostnames-and-ssh-config">Hostnames and SSH Config</h2>

<p>First adapt your <code class="highlighter-rouge">~/.ssh/config</code> and <code class="highlighter-rouge">etc/hosts</code> to list both machines
as <code class="highlighter-rouge">VLB1</code> and <code class="highlighter-rouge">VLB2</code>.  Then cofigure the remote hostnames:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "VLB1" | ssh VLB1 "cat | sudo tee /etc/hostname"
echo "127.0.0.1 VLB1" | ssh VLB1 "cat | sudo tee -a /etc/hosts"
</code></pre></div></div>

<p>Similarly for VLB2.</p>

<p>Remark: A drawback of this approach is that each time the 2nd command
is executed a new line is appended at to /etc/hosts. In particular the
command is not idempotent. An alternative variant would be to use
<code class="highlighter-rouge">sed</code> for a global string replacement, which has similar issues. <code class="highlighter-rouge">sed
s/VLB/VLB1/g</code> transforms <code class="highlighter-rouge">VLB -&gt; VLB1 -&gt; VLB11</code>. Maybe <code class="highlighter-rouge">sed
s/VLB$/VLB1/g</code> could work.</p>

<p>Also it would be nice to set /etc/hosts correctly on the remote, but
this gets too far. It seems <a href="http://zookeeper.apache.org/">zookeper</a>
is the right tool for this kind of problems.</p>

<h2 id="network-check">Network check</h2>

<p>To see if all hosts are sucessfully connected to the network, run a
ip-range scan. E.g.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap 192.168.56.*
</code></pre></div></div>

<p>You should see three machines at <code class="highlighter-rouge">.1</code>, <code class="highlighter-rouge">.101</code>, <code class="highlighter-rouge">.102</code>.</p>

<h2 id="startup-script">Startup Script</h2>

<p>Convenience script to start the whole “cluster” at once:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
nohup vboxheadless <span class="nt">-s</span> LinuxBox &amp;
nohup vboxheadless <span class="nt">-s</span> LinuxBox_1 &amp;
</code></pre></div></div>

<h1 id="references">References</h1>

<ul>
  <li><a href="http://cs.smith.edu/dftwiki/index.php/Setup_Virtual_Hadoop_Cluster_under_Ubuntu_with_VirtualBox">D. Thiebaut - Setup Virtual Hadoop Cluster under Ubuntu with VirtualBox</a></li>
</ul>


  <!-- Comments -->
  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'heinrichhartmann';
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments</a></noscript>
  
</div>


  <div class="footer">
    <div class="contact">
      <p>
        Licensed under <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC-BY 4.0.</a>
        <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title" style="display:none">This blog</span>
        <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName" style="display:none">Heinrich Hartmann</span>
      </p>
    </div>
  </div>
</div>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53959000-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
