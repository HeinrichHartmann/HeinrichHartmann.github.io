<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
   <title>Quantiles</title>
   <meta name="author" content="Heinrich Hartmann"/>

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css"/>

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection"/>

   <!-- RSS feed -->
   <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

   <!-- Favicon -->
   <link rel="icon" type="image/png" href="/images/favicon.png">

   
   </head>
<body>

<div class="site">
  <div class="headline"><a href="/">Heinrich Hartmann</a></div>
  <div class="title">
    <a class="extra" href="/">blog</a>
    <a class="extra" href="/math.html">math</a>
    <a class="extra" href="/opinion.html">opinion</a>
    <a class="extra" href="/consulting.html">consulting</a>
    <a class="extra" href="/about.html">about</a>
    <div class="social" style='float:right'>
      <!-- <div style='float:right'> -->
      <!--   <a href="http://eepurl.com/ccmH-T"><img src="/images/mail_icon.svg" width="25px"/></a> -->
      <!-- </div> -->
      <div style='float:right'>
        <a href="/feed.xml"><img src="/images/rss_icon.svg" width="25px" style="margin: 0 10px 0 0;"/></a>
      </div>
      <div style='float:right'>
        <a href="http://twitter.com/intent/follow?screen_name=HeinrichHartman"><img src="/images/twitter_icon.svg" width="25px" style="margin: 0 10px 0 0;"></a>
      </div>
    </div>
  </div>

  <div id="post">

  <!-- Title -->
  <h1> Quantiles</h1>

  

  <!-- Meta -->
  
  <p class="meta">
    Written on 2019-10-04
     in Stemwede, Germany 
    
  </p>

  <!-- Include Mathjax if needed -->
  
  <script type="text/javascript" async
          src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_SVG">
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$']],
        displayMath: [['$$','$$'], ["BEGIN_MATH","END_MATH"]]
      }
    });
    MathJax.Hub.Register.MessageHook("Math Processing Error", function(message)
                                     {
                                       console.log("MathJax error:");
                                       console.log(message);
                                     });
  </script>
  <!-- Mathjax preamble -->
  <div style="visibility:hidden; display:none;">
    $$
    \newcommand{\nl}{\\}

\newcommand{\half}{\frac{1}{2}}
\newcommand{\floor}[1]{\lfloor #1 \rfloor}
\newcommand{\ceil}[1]{\lceil #1 \rceil}
\newcommand{\Set}[2]{\left\{\, #1 \;\vert\; #2 \,\right\}}
\newcommand{\C}{\,\#}
\newcommand{\CSet}[2]{\#\{\, #1 \;\vert\; #2 \,\}}

\newcommand{\qtext}[1]{\quad\text{#1}\quad}
\newcommand{\stext}[1]{\;\text{#1}\;}

\newcommand{\IFF}{\Leftrightarrow}
\newcommand{\inf}{\infty}

\newcommand{\Ind}{\mathbb{1}}

\newcommand{\IR}{\mathbb{R}}
\newcommand{\IA}{\mathbb{A}}
\newcommand{\IB}{\mathbb{B}}
\newcommand{\IC}{\mathbb{C}}
\newcommand{\ID}{\mathbb{D}}
\newcommand{\IF}{\mathbb{F}}
\newcommand{\IH}{\mathbb{H}}
\newcommand{\II}{\mathbb{I}}
\newcommand{\IL}{\mathbb{L}}
\newcommand{\IN}{\mathbb{N}}
\newcommand{\IP}{\mathbb{P}}
\newcommand{\IQ}{\mathbb{Q}}
\newcommand{\IR}{\mathbb{R}}
\newcommand{\IS}{\mathbb{S}}
\newcommand{\IV}{\mathbb{V}}
\newcommand{\IZ}{\mathbb{Z}}

\newcommand{\KR}{\matcal{R}}
\newcommand{\KA}{\matcal{A}}
\newcommand{\KB}{\matcal{B}}
\newcommand{\KC}{\matcal{C}}
\newcommand{\KD}{\matcal{D}}
\newcommand{\KF}{\matcal{F}}
\newcommand{\KH}{\matcal{H}}
\newcommand{\KI}{\matcal{I}}
\newcommand{\KL}{\matcal{L}}
\newcommand{\KN}{\matcal{N}}
\newcommand{\KP}{\matcal{P}}
\newcommand{\KQ}{\matcal{Q}}
\newcommand{\KR}{\matcal{R}}
\newcommand{\KS}{\matcal{S}}
\newcommand{\KV}{\matcal{V}}
\newcommand{\KZ}{\matcal{Z}}

\newcommand{\gc}{\mathfrak{C}}
\newcommand{\gd}{\mathfrak{D}}
\newcommand{\gM}{\mathfrak{M}}
\newcommand{\gm}{\mathfrak{m}}
\newcommand{\gf}{\mathfrak{f}}
\newcommand{\gu}{\mathfrak{U}}

\newcommand{\fa}{\mathfrak{a}}
\newcommand{\fg}{\mathfrak{g}}
\newcommand{\fn}{\mathfrak{n}}
\newcommand{\fk}{\mathfrak{k}}
\newcommand{\fm}{\mathfrak{m}}
\newcommand{\fp}{\mathfrak{p}}

\newcommand{\curly}[1]{\mathcal{#1}}
\newcommand{\op}[1]{\mathrm{#1}}
\newcommand{\Cat}[1]{\mathfrak{#1}}
\newcommand{\cat}[1]{\mathbf{#1}}

\newcommand{\vphi}{\varphi}
\newcommand{\sphi}{\phi}
\newcommand{\eps}{\varepsilon}

\newcommand{\tensor}{\otimes}
\newcommand{\tensors}{\tensor\dots\tensor}
\newcommand{\Tensor}{\bigotimes}
\newcommand{\ra}{\rightarrow}
\newcommand{\lra}{\longrightarrow}
\newcommand{\la}{\leftarrow}
\newcommand{\lla}{\longleftarrow}
\newcommand{\isom}{\cong}
\newcommand{\epi}{\twoheadrightarrow}
\newcommand{\mono}{\hookrightarrow}
\newcommand{\del}{\partial}
\newcommand{\union}{\cup}
\newcommand{\dotcup}{\ensuremath{\mathaccent\cdot\cup}}
\newcommand{\dunion}{\dotcup}
\newcommand{\<}{\langle}
\renewcommand{\>}{\rangle}
\newcommand{\inpart}[1]{\in\text{\part}(#1)}
\newcommand{\Vsum}{\bigoplus}
\newcommand{\vsum}{\oplus}

\renewcommand{\S}{\mathfrak{S}}
\newcommand{\id}{\mathrm{id}}
\newcommand{\rk}{\mathrm{rk}}
\newcommand{\Diff}{\mathrm{Diff}}
\newcommand{\Hom}{\mathrm{Hom}}
\newcommand{\Pic}{\mathrm{Pic}}
\newcommand{\Spec}{\mathrm{Spec}}
\newcommand{\End}{\mathrm{End}}
\newcommand{\Ext}{\mathrm{Ext}}

\DeclareMathOperator{\Supp}{\mathrm{Supp}}
\DeclareMathOperator{\Sym}{Sym}
\DeclareMathOperator{\Alt}{\Lambda}
\DeclareMathOperator{\ad}{ad}
\DeclareMathOperator{\ch}{ch}
\DeclareMathOperator{\td}{td}
\DeclareMathOperator{\pr}{pr}

    $$
  </div>
  

  <!-- Splash -->
  

  <!-- Abstract -->
  
  <p class="abstract">Quantiles and percentiles are an essential tool for the qualitative analysis of telemetry data. In particular, they have become an integral part of performance analysis in the IT domain. Despite their wide use, there are a number of competing definitions of quantiles commonly found in the wild. In this note we will explain how these definitions arise and study their relation in detail. This includes formal relationships, and empirical analysis of practical examples.
</p>
  

  <!-- Post content -->
  <h2 class="no_toc" id="contents">Contents</h2>

<ul id="markdown-toc">
  <li><a href="#quantiles-for-random-variables" id="markdown-toc-quantiles-for-random-variables">Quantiles for Random Variables</a></li>
  <li><a href="#quantiles-for-datasets" id="markdown-toc-quantiles-for-datasets">Quantiles for Datasets</a></li>
  <li><a href="#empirical-quantiles" id="markdown-toc-empirical-quantiles">Empirical Quantiles</a></li>
  <li><a href="#quantiles-via-sorting" id="markdown-toc-quantiles-via-sorting">Quantiles via Sorting</a></li>
  <li><a href="#practical-choice-the-minimal-quantile-for-a-dataset" id="markdown-toc-practical-choice-the-minimal-quantile-for-a-dataset">Practical Choice: The Minimal Quantile for a Dataset</a></li>
  <li><a href="#interpolated-quantiles" id="markdown-toc-interpolated-quantiles">Interpolated Quantiles</a></li>
  <li><a href="#interpolated-quantiles-from-probability-distributions" id="markdown-toc-interpolated-quantiles-from-probability-distributions">Interpolated Quantiles from Probability Distributions</a></li>
  <li><a href="#comparison-empirical-vs-interpolated-quantiles" id="markdown-toc-comparison-empirical-vs-interpolated-quantiles">Comparison: Empirical vs. Interpolated Quantiles</a></li>
  <li><a href="#quantile-implementations" id="markdown-toc-quantile-implementations">Quantile Implementations</a>    <ul>
      <li><a href="#numpy" id="markdown-toc-numpy">Numpy</a></li>
      <li><a href="#scipy" id="markdown-toc-scipy">Scipy</a></li>
      <li><a href="#r" id="markdown-toc-r">R</a></li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<h2 id="quantiles-for-random-variables">Quantiles for Random Variables</h2>

<p>Let $P$ be a probability distribution on the real axis, and $X$ a $P$-distributed random variable.</p>

<p><strong>Definition.</strong> 
For any number $q \in [0,1]$, a <em>naive q-quantile</em> for $P$ is a number <script type="math/tex">y \in \IR</script>, so that
BEGIN_MATH
    P[X \leq y] = q.
END_MATH</p>

<p><strong>Remark.</strong></p>
<ul>
  <li>
    <p>Naive quantiles do not always exist. Take $P=\delta_0$. Here only the numbers 0,1 are realized as naive quantiles.</p>
  </li>
  <li>
    <p>Naive quantile are not always unique. Take $q=.5$ and $P=\half (\delta_0 + \delta_1)$. Here every number $y\in(0,1)$ qualifies as a $.5$-quantile.</p>
  </li>
</ul>

<p>To improve the situation, we make the following adjustments to the above definition.</p>

<p><strong>Definition.</strong>
A number $y$ is a q-quantile, for some number $q \in [0,1]$, and a random variable $X$,
if the following conditions are met:
BEGIN_MATH
   P[X &lt; y] \leq q \qtext{and} P[X &gt; y] \leq 1-q
END_MATH</p>

<p><strong>Example.</strong> If $P=\delta_0$, then</p>
<ul>
  <li>All numbers $y \leq 0$ qualify as 0 quantile.</li>
  <li>All numbers $y \geq 0$ qualify as 1 quantile.</li>
  <li>All other $0&lt;q&lt;1$-quantiles are $0$.</li>
</ul>

<p><strong>Example.</strong> If $P=\half (\delta_0 + \delta_1)$, then:</p>

<ul>
  <li>For $0&lt;q&lt;.5$ only $y=0$ is a $q$-quantile.</li>
  <li>For $q=.5$ all numbers $0&lt;y&lt;1$, are $.5$-quantiles.</li>
  <li>For $.5&lt;q&lt;1$ only $y=1$ is a $q$-quantile.</li>
</ul>

<p><strong>Remark</strong>.</p>
<ul>
  <li>For every $P,q$ there is at least one $q$-quantile.</li>
  <li>As we have seen $q$-quantiles might be non-unique.</li>
  <li>If $X$ has a probability density $p$, which is positive everywhere, then all quantiles are unique.</li>
</ul>

<p>This definition of Quantile seems to be universally agreed up-on.
At least this is what I learned at University (e.g. <a href="https://www.degruyter.com/view/product/184322">Georgii - Statistics</a>).
and how <a href="https://en.wikipedia.org/wiki/Quantile">Wikipedia</a> (accessed on 2019-05-13) defines this.
Also I don’t see much room for an alternative definition in this setting.</p>

<h2 id="quantiles-for-datasets">Quantiles for Datasets</h2>

<p>Given a dataset $D=(x_1,…x_n)$ of real numbers, with $n \geq 1$, how can we define quantiles for D?</p>

<p>We will give a few different competing definitions below.
But there are a number of undisputed properties, that everyone will find desirable.</p>

<p><strong>Desirable Properties.</strong></p>

<ul>
  <li>(A) The minimum is a $0$-quantile.</li>
  <li>(B) The maximum is a $1$-quantile.</li>
  <li>(C) The <a href="https://en.wikipedia.org/wiki/Median">median value</a> is a $.5$ quantile.</li>
  <li>(D) For $D=(x_1 &lt; \dots &lt; x_n), n\geq 2$ the number $x_k$ should be an $\frac{k-1}{n-1}$ quantile.</li>
</ul>

<p>Special cases of (D) are</p>

<ul>
  <li>For $D=(0,1,2)$, then $x_2=1$ should be a .5-quantile.</li>
  <li>For $D=(0,1,\dots,10)$, then $x_{10}=9$ should be a .9-quantile.</li>
</ul>

<p>One natural and very general approach is to assign a probability distribution $P$ to $D$,
and then take the quantiles of $P$ as we defined them above.
We will follow this strategy in the next sections.</p>

<h2 id="empirical-quantiles">Empirical Quantiles</h2>

<p>The simplest probability distribution we can assign to $D$, is the so-called <em>empirical</em> distribution,
which looks like this:
BEGIN_MATH
    P_{emp} = \frac{1}{\C D} \sum_{x \in D} \delta_x = \frac{1}{n} \sum_{x=1}^n \delta_{x_i}
END_MATH</p>

<p>So a random variable $X_{emp} \sim P_{emp}$ takes values that are uniformly randomly chosen from $D$.</p>

<p><strong>Definition.</strong> An <em>empirical $q$-quantile</em> for D is a $q$-quantile of $P_{emp}$.
This means, that the following conditions should be met:
BEGIN_MATH
  \frac{\CSet{x \in D}{x &lt; y}}{\C D} \leq q \qtext{and} \frac{\CSet{x \in D}{x &gt; y}}{\C D} \leq 1-q.
END_MATH</p>

<p><strong>Remark.</strong>
Since empirical quantiles are quantiles of a probability distribution,
empirical quantiles always exists but are potentially non-unique.</p>

<p><strong>Proposition.</strong> Empirical quantile satisfy desirable properties (A)-(F).</p>

<p><strong>Proof.</strong></p>
<ul>
  <li>
    <p>(A) For $y=max(D),q=1$, we have
BEGIN_MATH
\begin{align}
\CSet{x \in D}{x &lt; y} &amp;\leq n-1 \leq n q \nl
\CSet{x \in D}{x &gt; y} &amp;= 0 \leq n (1-q).
\end{align}
END_MATH</p>
  </li>
  <li>
    <p>(B) For $y=min(D),q=0$, we have
BEGIN_MATH
\begin{align}
\CSet{x \in D}{x &lt; y} &amp;= 0 \leq n q \nl
\CSet{x \in D}{x &lt; y} &amp;\leq n-1 \leq n.
\end{align}
END_MATH</p>
  </li>
  <li>
    <p>(C) For $y=median(D), q=.5$, we have
BEGIN_MATH
\begin{align}
\CSet{x \in D}{x &lt; y} &amp;\leq n/2 = q n \nl
\CSet{x \in D}{x &gt; y} &amp;\leq n/2 = (1-q) n.
\end{align}
END_MATH</p>
  </li>
  <li>
    <p>(D) For $D=(x_1,…,x_n)$, $y=x_k$, $q=k/(n-1)$, we have:
BEGIN_MATH
\begin{align}
\CSet{x \in D}{x &lt; x_k} &amp;= k-1 \leq \frac{n}{n-1} (k-1) = q n \nl
\CSet{x \in D}{x &gt; x_k} &amp;= n-k \leq \frac{n}{n-1} (n-k) = (1-q) n.
\end{align}
END_MATH</p>
  </li>
</ul>

<p>QED.</p>

<p><strong>Comment.</strong>
I always assumed that this was the only sensible quantile definition for datasets, that should be used.
Hence, this is what I used in my <a href="https://github.com/HeinrichHartmann/Statistics-for-Engineers">Statistics for Engineers</a> 
courses.
As we will see, there are competing views on this.</p>

<h2 id="quantiles-via-sorting">Quantiles via Sorting</h2>

<p>Quantiles of datasets are commonly computed by sorting the dataset.</p>

<p>Let
BEGIN_MATH
  D_{sorted} = (x_{(1)} \leq x_{(2)} \leq \dots \leq x_{(n)}) 
END_MATH
be the sorted version of $D$.
As a convention we set $x_{(i)}=-\infty$ for $i \leq 0$ and $x_{(i)} = \infty$ for $i &gt; n$.</p>

<p>In order to simplify the arguments below we introduce the following notation:
BEGIN_MATH
\begin{align}
Count_{&lt;}(D; y)   &amp;= \CSet{ x \in D }{ x &lt; y } \quad &amp; \quad
Count_{\leq}(D; y) &amp;= \CSet{ x \in D }{ x \leq y } \nl
Count_{&gt;}(D; y) &amp;= \CSet{ x \in D }{ x &gt; y } \quad &amp; \quad
Count_{\geq}(D; y) &amp;= \CSet{ x \in D }{ x \geq y } \nl
\end{align}
END_MATH</p>

<p>Clearly we have:</p>

<p>BEGIN_MATH
\begin{gather}
  Count_{&lt;}(D; y) + Count_{\geq}(D; y) = \C D = n \nl
  Count_{\leq}(D; y) + Count_{&gt;}(D; y) = \C D = n.
\end{gather}
END_MATH</p>

<p>The following lemma summarizes the relation between counts and the position of $x$ in $D_{sorted}$.</p>

<p><strong>Lemma.</strong>
For a dataset D and a number $k \in \{1,\dots,n\}$ we have:
BEGIN_MATH
  Count_{&lt;}(D; x_{(k)}) \leq k-1 \qtext{and} Count_{\leq}(D; x_{(k)}) \geq k.
END_MATH
For any number $y$ and $k \in {1,\dots,n}$ we have:
BEGIN_MATH
\begin{align}
  Count_{&lt;}(D; y) \geq k \;\IFF\; x_{(k)} &lt; y, &amp;\quad
  Count_{\leq}(D; y) \geq k \;\IFF\; x_{(k)} \leq y \nl
  Count_{&lt;}(D; y) \leq k \;\IFF\; x_{k(+1)} \geq y, &amp;\quad
  Count_{\leq}(D; y) \leq k \;\IFF\; x_{(k+1)} &gt; y \nl
\end{align}
END_MATH</p>

<p><strong>Proof.</strong> 
For the first inequalities it suffices to note that, of all numbers in $D$, at most the numbers $x_{(1)},\dots,x_{(k-1)}$ might be smaller than $x_{(k)}$.
For the second one, we have at least $k$ numbers $x_{(1)},\dots,x_{(k)}$ which are smaller or equal to $x_{(k)}$.</p>

<p>Now to the next set of inequalities:
We have $Count_{&lt;}(D; y) \geq k$ if and only if $x_{(1)},\dots,x_{(k)} &lt; y$, 
which is the case if and only if $x_{(k)}&lt;y$.
Similarly for $Count_{\leq}$.</p>

<p>We have $Count_{&lt;}(D; y) \leq k$ if and only if $Count_{\geq}(D; y) \geq n - k$.
This is the case if and only if $x_{(n)},\dots, x_{(n-(n-k)+1)} = x_{(k+1)} \geq y$.
Similarly for $Count_{\leq}$. QED.</p>

<p><strong>Theorem.</strong> The empirical $q$-quantiles are exactly the numbers $x_{(a)} \leq y \leq x_{(b)}$ with
BEGIN_MATH
  a = \ceil{q n} \qtext{and} b = \floor{q n} + 1.
END_MATH</p>

<p><strong>Proof.</strong> With the above notation, the empirical quantile condition looks like this:
BEGIN_MATH
   Count_{&lt;}(D; y) \leq q n \qtext{and} Count_{&gt;}(D; y) \leq (1-q) n.
END_MATH</p>

<p>Lets assume $Count_&lt;(D; y) \leq n q$.
Since $Count_&lt;(D; y)$ is an integer, this condition is equivalent to $Count_&lt;(D; y) \leq \floor{n q} = b-1$.
By the last lemma we know that his is the case if and only if $y \leq x_{(b)}$.</p>

<p>Similarly, let’s assume $Count_{&gt;}(D; y) \leq (1-q) n$.
Subtracting form $n$ on both side, this is equivalent to $Count_\leq(D; y) \geq n q$.
Since $Count_\leq(D; y)$ is an integer, this condition is equivalent to $Count_&lt;(D; y) \geq \ceil{n q} = a$.
By the last lemma we know that this is the case if and only if $y \geq x_{(a)}$.</p>

<p>QED.</p>

<p>In the light of the theorem, we make the following definition.</p>

<p><strong>Definition.</strong>
For any number $n$ and $0 \leq q \leq 1$ we define the quantile indices</p>

<script type="math/tex; mode=display">k^{min}_q(n) = \ceil{q n} \qtext{and} k^{max}_q(n) = \floor{q n} + 1.</script>

<p>And for a dataset $D$ of length $n$ we define the minimal and maximal empirical $q$-quantiles as:</p>

<script type="math/tex; mode=display">\newcommand{QEMIN}[1]{Q_{emp}^{min}(D; #1)}
\newcommand{QEMAX}[1]{Q_{emp}^{max}(D; #1)}
\newcommand{QE}[1]{Q_{emp}(D; #1)}

  \QEMIN{q} = x_{(k^{min}_q(n))} \qtext{and} \QEMAX{q} = x_{(k^{max}_q(n))}.</script>

<p>where $x_{(k)}$ is the k-th entry in $D_{sorted}$.</p>

<p>Furthermore, we call</p>

<script type="math/tex; mode=display">\QE{q} = \frac{1}{2} (Q_q^{min}(D) + Q_q^{max}(D))</script>

<p>the central empirical $q$-quantile.</p>

<p><strong>Example.</strong>  For $n=1, D=(x)$we have the following quantiles:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">$q$</th>
      <th style="text-align: right">$k^{min}_q$</th>
      <th style="text-align: right">$k^{max}_q$</th>
      <th style="text-align: right">$\QEMIN{q}$</th>
      <th style="text-align: right">$\QEMAX{q}$</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">$-\infty$</td>
      <td style="text-align: right">$x$</td>
      <td>Every number $y \leq x$ is a 0-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$0&lt;q&lt;1$</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">$x$</td>
      <td style="text-align: right">$x$</td>
      <td>Only $y=0$ is a $q$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">$x$</td>
      <td style="text-align: right">$\infty$</td>
      <td>Every number $y \geq x$ is a 1-quantile</td>
    </tr>
  </tbody>
</table>

<p><strong>Example.</strong> For $n=2, D=(x_1 \leq x_2)$ we have:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">$q$</th>
      <th style="text-align: right">$qn$</th>
      <th style="text-align: right">$k^{min}_q$</th>
      <th style="text-align: right">$k^{max}_q$</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td>Every number $y \leq x_1$ is a 0-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$0&lt;q&lt;1/2$</td>
      <td style="text-align: right">0 &lt; $qn$ &lt; 1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td>Only $y=x_1$ is a $q$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/2$</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">2</td>
      <td>Every $x_1 \leq y \leq x_2$ is a $1/2$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/2&lt;q&lt;1$</td>
      <td style="text-align: right">1 &lt; $qn$ &lt; 2</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2</td>
      <td>Only $y=x_2$ is a $q$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">3</td>
      <td>Every number $y \geq x_2$ is a 1-quantile</td>
    </tr>
  </tbody>
</table>

<p><strong>Example.</strong> For $n=4, D=(x_1\leq \dots \leq x_4)$ we have:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">$q$</th>
      <th style="text-align: right">$qn$</th>
      <th style="text-align: right">$k^{min}_q$</th>
      <th style="text-align: right">$k^{max}_q$</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">1</td>
      <td>Every number $y \leq x_1$ is a 0-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$0&lt;q&lt;1/4$</td>
      <td style="text-align: right">0 &lt; $qn$ &lt; 1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td>Only $y=x_1$ is a $q$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/4$</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">2</td>
      <td>Every $x_1 \leq y \leq x_2$ is a $1/4$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/4&lt;q&lt;1/2$</td>
      <td style="text-align: right">1 &lt; $qn$ &lt; 2</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2</td>
      <td>Only $y=x_2$ is a $q$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/2$</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">3</td>
      <td>Every $x_2 \leq y \leq x_3$ is a $1/2$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/2&lt;q&lt;3/4$</td>
      <td style="text-align: right">2 &lt; $qn$ &lt; 3</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">3</td>
      <td>Only $y=x_3$ is a $q$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$3/4$</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">4</td>
      <td>Every $x_3 \leq y \leq x_4$ is a $3/4$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$3/4&lt;q&lt;1$</td>
      <td style="text-align: right">3 &lt; $qn$ &lt; 4</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">4</td>
      <td>Only $y=x_4$ is a $q$-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">5</td>
      <td>Every number $y \geq x_4$ is a 1-quantile</td>
    </tr>
  </tbody>
</table>

<p>The following figure illustrates the quantile locations for $n=4$.</p>

<figure id="figure-1"><a href="/assets/1578112376cb5b906577b616.png"><img src="/assets/1578112376cb5b906577b616.png" alt="Empirical quantile locations for n=4." /></a><figcaption>Figure 1: Empirical quantile locations for n=4. [<a href="/assets/1578112376cb5b906577b616.png">PNG</a>]</figcaption></figure>

<p><strong>Comment.</strong> A frequently cited source for practical quantile computation is [Hyndman-Fan 1996].
This paper contains a list of 9 different types of quantile definitions that are found in the wild.
The minimal empirical quantile $\QEMIN{q}$ is the very fist in their list (Type 1):</p>

<blockquote>
  <p>Definition 1. The oldest and most studied definition is the inverse of the empirical distribution function obtained by …
For this definition $Freq(X_k &lt; Q_1(P)) = \ceil{pn}$</p>
</blockquote>

<p>The central empirical quantile $\QE{q}$ is the second entry in their list (Type 2):</p>

<blockquote>
  <p>Definition 2. $Q_2(p)$ is similar to $Q_1(p)$except that averaging is used when $g=0$…</p>
</blockquote>

<p>This underlines the practical relevance of the empirical quantiles.</p>

<h2 id="practical-choice-the-minimal-quantile-for-a-dataset">Practical Choice: The Minimal Quantile for a Dataset</h2>

<p>In practical applications one often want’s to make statements of the form:</p>

<blockquote>
  <p>95% of all requests were served within 500ms.</p>
</blockquote>

<p>The quantile version that allows you to make those statements exactly, is the minimal empirical quantile.</p>

<p><strong>Proposition.</strong> For a dataset $D$, the following statements are equivalent:</p>

<ul>
  <li>
    <p>p% of all samples in $D$ were less or equal to y.</p>
  </li>
  <li>
    <p>The the minimal p/100 quantile, was greater or equal to y: $\QEMIN{p/100} \geq y$.</p>
  </li>
</ul>

<p><strong>Proof.</strong> We have seen in the proof of the last theorem, that the condition
$Count_\leq(D; y) \geq n q$ is equivalent to $y \geq \QEMIN{q}$. QED.</p>

<p><strong>Comment.</strong> 
This proposition shows, that the empirical quantiles give precise answers to practical questions 
that arise in the formulation of latency SLAs/SLOs (cf. <a href="https://www.circonus.com/2018/08/latency-slos-done-right">blog</a>).</p>

<h2 id="interpolated-quantiles">Interpolated Quantiles</h2>

<p>We already mentioned, that for any definition of quantile we want that 
$x_{(1)}=min(D)$ should be a $0$-quantile, and $max(D)=x_{(n)}$ should be a $1$-quantile.
It’s tempting to define the remaining quantiles by interpolation.</p>

<p>The unique linear function $r$ that interpolates between these cases $r(0)=0$ and $r(1)=1$ is
$r(q)= q (n-1) + 1$. Hence it’s natural to consider the following indices:</p>

<p>BEGIN_MATH
  l^{min}_q = \floor{r(q)}= \floor{q(n-1)} + 1 \quad\text{and}\quad l^{max}_q = \ceil{r(q)} = \ceil{q (n-1)} + 1.
END_MATH</p>

<p><strong>Definition.</strong> For a dataset $D$ of size $n\geq 2$ and a number $0\leq q \leq 1$ we
define the interpolated quantile as:</p>

<script type="math/tex; mode=display">\newcommand{\QI}{Q_{int}(D; q)}
\newcommand{\QIMIN}{Q_{int}^{min}(D; q)}
\newcommand{\QIMAX}{Q_{int}^{max}(D; q)}

   \QI = (1-\gamma) x_{(l^{min}_q)} + \gamma x_{(l^{max}_q)}</script>

<p>where $\gamma = q(n-1) - \floor{q(n-1)}$ with $0 \leq \gamma &lt; 1$.
Furthermore we introduce the notation</p>

<script type="math/tex; mode=display">\QIMIN = x_{(l^{min}_q)}, \quad \QIMAX = x_{(l^{max}_q)}</script>

<p>for the minimal and maximal interpolated $q$-quantiles.</p>

<p><strong>Proposition.</strong> 
The interpolated $q$-quantile $\QI$ is a continues, piece-wise linear function in $q$, 
with break point at $q=(k-1)/(n-1)$ at which the following values are assumed:</p>

<script type="math/tex; mode=display">Q_{int}(D; \frac{k-1}{n-1}) = x_{(k)} \qtext{for} k = 1,\dots,n.</script>

<p><strong>Proof</strong>.
We have $\gamma=0$ precisely at the break-points $q=(k-1)/(n-1)$ for $k=1,n$.</p>

<p>So if $q=(k-1)/(n-1)$, then</p>

<script type="math/tex; mode=display">\QI = x_{(l^{min})} = x_{(k)}</script>

<p>And if $q=(k-1)/(n-1) + \gamma/(n-1)$, with $0 &lt; \gamma &lt; 1$, then $\gamma(q) = q(n-1) - k + 1$
and $l^{min}=k$ $l^{max}=k+1$.
So</p>

<script type="math/tex; mode=display">\QI = (1-\gamma(q)) x_{(k)} + \gamma(q) x_{(k+1)}</script>

<p>is a linear function in $q$.
Note that for $\gamma=0$ and $\gamma=1$ this agrees with the formula for the break-points.
QED.</p>

<p><strong>Example.</strong> For $D=(1,\dots,n)$ the interpolated $q$-quantile is exactly 
$\QI = r(q) = q(n-1) + 1$.</p>

<p><strong>Proposition.</strong> The interpolated quantile satisfies the desirable properties (A) - (D) from above.</p>

<p><strong>Proof.</strong> (A-C) are direct calculations. We have just proved (D). QED.</p>

<p><strong>Example</strong> For $n=4$ the interpolated quantile ranges are at the following positions:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">$q$</th>
      <th style="text-align: right">$r(q)$</th>
      <th style="text-align: right">$l^{min}_q$</th>
      <th style="text-align: right">$l^{max}_q$</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td>Only $y \leq x_1$ is a 0-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$0&lt;q&lt;1/3$</td>
      <td style="text-align: right">1 &lt; $r$ &lt; 2</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">2</td>
      <td>The $q$-quantile lies between $x_{1},x_{2}$</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/3$</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2</td>
      <td>Only $y \leq x_2$ is a 1/3-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$1/3&lt;q&lt;1/3$</td>
      <td style="text-align: right">2 &lt; $r$ &lt; 3</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">3</td>
      <td>The $q$-quantile lies between $x_{2},x_{3}$</td>
    </tr>
    <tr>
      <td style="text-align: center">$2/3$</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">3</td>
      <td>Only $y \leq x_3$ is a 2/3-quantile</td>
    </tr>
    <tr>
      <td style="text-align: center">$2/3&lt;q&lt;1$</td>
      <td style="text-align: right">3 &lt; $r$ &lt; 4</td>
      <td style="text-align: right">3</td>
      <td style="text-align: right">4</td>
      <td>The $q$-quantile lies between $x_{3},x_{4}$</td>
    </tr>
    <tr>
      <td style="text-align: center">$1$</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">4</td>
      <td>Only $y \leq x_4$ is a 1-quantile</td>
    </tr>
  </tbody>
</table>

<p>The following figure illustrates the interpolated quantile ranks for $n=4$.</p>

<figure id="figure-2"><a href="/assets/8e78c2ac5f8f6159515bcdd7.png"><img src="/assets/8e78c2ac5f8f6159515bcdd7.png" alt="Interpolated quantile ranks for n=4." /></a><figcaption>Figure 2: Interpolated quantile ranks for n=4. [<a href="/assets/8e78c2ac5f8f6159515bcdd7.png">PNG</a>]</figcaption></figure>

<p><strong>Comment.</strong> The Hyndman-Fan list includes our interpolated quantiles as Type 7 quantiles, 
and attributes them to Gumbel “La Probabilite des Hypotheses” from 1939.</p>

<h2 id="interpolated-quantiles-from-probability-distributions">Interpolated Quantiles from Probability Distributions</h2>

<p>It is possible to construct a probability distribution that has $\QI$ as associated $q$-quantile.
To simplify the discussion, we limit ourselves to the case that $x_{(1)} &lt; \dots &lt; x_{(n)}$ here.</p>

<p>Roughly speaking, we need to construct a probability density function, that spreads 
the weight of $x_{(k)}$ evenly, across the space between the next higher and next lower samples.
One way to do so is to consider the following probability density functions</p>

<script type="math/tex; mode=display">% <![CDATA[
p_k(x) = \frac{1}{x_{(k+1)} - x_{(k)}}  \mathbb{1}[ x_{(k)} \leq x < x_{(k+1)} ](x), \quad k=1,\dots,n-1 %]]></script>

<p>for which are supported on $[x_{(k)}, x_{(k+1)})$ and integrates to 1.</p>

<p>For each central sample $x_{(2)} \leq x_{(k)} \leq x_{(n-1)}$ we associate $\half (p_{k-1} + p_{k})$.
The boundary samples $x_{(1)}, x_{(n)}$ only get a half-weight density $\half p_1, \half p_{n-1}$ respectively.
Summing up we get a probability density function:</p>

<script type="math/tex; mode=display">p(x) = \frac{1}{n-1}( \half p_1(x) + \sum_{k=2}^{n-1} \half (p_{k-1}(x) + p_{k}(x)) + \half p_{n-1}(x)) \\
         = \frac{1}{n-1}( p_1(x) + \dots + p_{n-1}(x))</script>

<p><strong>Proposition.</strong> The cumulative distribution function associated to p(x)</p>

<script type="math/tex; mode=display">\DeclareMathOperator{\cdf}{cdf}

\cdf(x) = \int_{-\infty}^x p(x) dx = \frac{1}{n-1} \sum_{k=1}^{n-1} \int_{-\inf}^{x} p_k(t) dt</script>

<p>has the property that:</p>

<ol>
  <li>$\cdf(x)$ is continuous and piece-wise linear between $x_{(k)}$ and $x_{(k+1)}$.</li>
  <li>$\cdf(x_{(k)}) = (k-1)/(n-1)$.</li>
</ol>

<p><strong>Proof.</strong> Ad 1) We know that $\frac{d}{dx}\cdf(x) = p(x)$ is constant on between $x_{(k)}$ and $x_{(k+1)}$.
Hence $\cdf(x)$ is linear on those intervals.</p>

<p>Ad 2) We have $\int_{-\inf}^{x_{(k)}} p_l(t) = 0$ for $k \leq l$, and 
$\int_{-\inf}^{x_{(k)}} p_l(t) = 1$ for $k \geq l+1$.
So</p>

<script type="math/tex; mode=display">\cdf(x_{(k)}) = \frac{1}{n-1} \sum_{l=1}^{n-1} \Ind[l \leq k-1](l) = \frac{k-1}{n-1}</script>

<p><strong>Corollary.</strong> The interpolated quantiles are quantiles for the probability distribution with density $p$.</p>

<p><strong>Proof.</strong> The composition $f(q) = \cdf(Q_{int}(q))$ is again a continues, piece-wise linear function.
It suffices to show that $f(q)=q$ on the breakpoints of $f$.</p>

<p>The breakpoints of $\QI$ at $q=(k-1)/(n-1)$, $k=1,\dots,n$ map to the breakpoints of $\cdf(x)$ at $x_{(k)}$,
Hence the break-points of the composition $f(q)$ are again at $q=(k-1)/(n-1)$. At those points we have:</p>

<script type="math/tex; mode=display">f(q) = \cdf(Q_{int}(q)) = \cdf{x_{(k)}} = \frac{k-1}{n-1} = q.</script>

<p>Now,</p>

<script type="math/tex; mode=display">% <![CDATA[
P[X < \QI] = \cdf(\QI) = q \qtext{and} P[X > \QI] = 1-\cdf(Q_{int}(q)) = 1-q. %]]></script>

<p>QED.</p>

<h2 id="comparison-empirical-vs-interpolated-quantiles">Comparison: Empirical vs. Interpolated Quantiles</h2>

<p>The qualitative differences between empirical- and interpolated quantiles
can be well observed in the case $n=4$:</p>

<figure id="figure-3"><a href="/assets/b5bb25c8537a6e8034baf16a.png"><img src="/assets/b5bb25c8537a6e8034baf16a.png" alt="Empirical vs. Interpolated quantiles for n=4" /></a><figcaption>Figure 3: Empirical vs. Interpolated quantiles for n=4 [<a href="/assets/b5bb25c8537a6e8034baf16a.png">PNG</a>]</figcaption></figure>

<p>We can see that:</p>

<ul>
  <li>The interpolated quantiles, take the desirable quantile values at $k/3$ as a basis and interpolate between them.</li>
  <li>
    <p>The empirical quantiles, jump at $q=k/4$ to the locations of the samples.</p>
  </li>
  <li>There are no strict inequalities between the quantile, but for low values of $q$ the interpolated quantile is generally larger than the empirical one. For high values of $q$ the interpolated quantiles are generally lower than the empirical ones.</li>
</ul>

<p>Also in this example empirical and interpolated quantiles are not far apart. 
In fact, we have the following proposition.</p>

<p><strong>Proposition.</strong> 
For all numbers $0 \leq q \leq 1$ we have:</p>

<script type="math/tex; mode=display">\QIMIN \leq  \QEMIN{q} \leq \QE{q} \leq \QEMAX{q} \leq  \QIMAX</script>

<p><strong>Proof.</strong> 
The cases $q=0$ and $q=1$ are trivial.
It suffices to show, that for $0&lt;q&lt;1$, we have</p>

<script type="math/tex; mode=display">l^{min}_q \leq k^{min}_q \leq k^{max}_q \leq l^{max}_q.</script>

<p>We distinguish the cases (A) $q n$ is an integer and (B) $q n$ is not integer.</p>

<p>Case A) Assume $q n$ is an integer.  Then $\floor{nq} = \ceil{nq} = qn$.
Hence</p>

<script type="math/tex; mode=display">l^{min}_q = \floor{q (n-1)} + 1 = \floor{qn - q} + 1 = nq + \floor{-q} + 1 \leq nq = \ceil{qn} = k^{min}_q.</script>

<p>and</p>

<script type="math/tex; mode=display">k^{max}_q = \floor{q n} + 1 = nq + 1 = \ceil{q (n-1)} + 1 = l^{max}_q.</script>

<p>Case B) Assume $q n$ is not an integer. 
Then $\ceil{q n} = \floor{q n}+1$ and we find:</p>

<script type="math/tex; mode=display">l^{min}_q = \floor{q (n-1) + 1} \leq \floor{qn + 1} = \floor{qn} + 1 = \ceil{q n} = k^{min}_q.</script>

<p>also, since $qn \leq q(n-1) + 1$ for $0\leq q \leq 1$, we find</p>

<script type="math/tex; mode=display">k^{max}_q = \floor{q n} + 1 = \ceil{qn} \leq \ceil{q (n-1) + 1} = l^{max}_q.</script>

<p>QED.</p>

<p><strong>Proposition.</strong> Empirical quantile and interpolated quantiles are no more than one sample apart:</p>

<script type="math/tex; mode=display">| \QE{q} - \QI | \leq max \Set{ x_{(k+1)} - x_{(k)} }{ k = 1,\dots,n }</script>

<p><strong>Proof.</strong> We have seen that the quantile indices satisfy:</p>

<script type="math/tex; mode=display">l^{min}_q \leq k^{min}_q \leq k^{max}_q \leq l^{max}_q</script>

<p>So $Q_{emp}(q)$ and $Q_{int}(q)$ both lie within $[x_{(l_q^{min})}, x_{(l_q^{max})}]$.
But $|l^{max}_q - l^{min}_q| \leq 1$, hence the difference between the quantiles is bounded 
by the maximal distance of adjacent samples. QED.</p>

<p><strong>Example.</strong>
There are cases where interpolated and empirical quantiles are far apart.
A common example where this is the case is are long tailed distributions with outliers,
and we are interested in high quantiles like $.99,.999$. 
In these regions samples are sparse and far apart.</p>

<figure id="figure-4"><a href="/assets/8ce5431c59a5eb0697b8ff30.png"><img src="/assets/8ce5431c59a5eb0697b8ff30.png" alt="Empirical vs. Interpolated quantiles for a Paretro Distribution with outliers" /></a><figcaption>Figure 4: Empirical vs. Interpolated quantiles for a Paretro Distribution with outliers [<a href="/assets/8ce5431c59a5eb0697b8ff30.png">PNG</a>]</figcaption></figure>

<p>This figure shows data sampled from a Paretro distribution with added outliers like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">D</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">pareto</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span>
    <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">pareto</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">800</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">]</span>
</code></pre></div></div>

<p>We have marked the following quantile values</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">q</th>
      <th style="text-align: right">Empirical Quantile</th>
      <th style="text-align: right">Interpolated Quantile</th>
      <th style="text-align: right">Delta</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">.95</td>
      <td style="text-align: right">15.920</td>
      <td style="text-align: right">15.927</td>
      <td style="text-align: right">0.007 (0%)</td>
    </tr>
    <tr>
      <td style="text-align: right">.995</td>
      <td style="text-align: right">1386.133</td>
      <td style="text-align: right">793.232</td>
      <td style="text-align: right">592.901 (42%)</td>
    </tr>
    <tr>
      <td style="text-align: right">.9995</td>
      <td style="text-align: right">1623.282</td>
      <td style="text-align: right">1584.152</td>
      <td style="text-align: right">39.13 (2.4%)</td>
    </tr>
  </tbody>
</table>

<p>So we see, that the difference between the values can be quite significant in the long tail.</p>

<h2 id="quantile-implementations">Quantile Implementations</h2>

<p>Let’s take a look at how quantiles are implemented in some popular data processing tools.</p>

<h3 id="numpy">Numpy</h3>
<p>The NumPy function <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.percentile.html">np.percentile</a>, implements interpolated quantiles.
As of this writing, there are no options for calculating empirical quantiles with NumPy’s percentile function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">D</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span> <span class="c"># grid</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">"linear"</span><span class="p">)</span> <span class="c"># default setting</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">"lower"</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">"higher"</span><span class="p">)</span>
</code></pre></div></div>

<figure id="figure-5"><a href="/assets/0cae73fb147382983203ef8e.png"><img src="/assets/0cae73fb147382983203ef8e.png" alt="Quantiles as computed by the np.percentile function." /></a><figcaption>Figure 5: Quantiles as computed by the np.percentile function. [<a href="/assets/0cae73fb147382983203ef8e.png">PNG</a>]</figcaption></figure>

<h3 id="scipy">Scipy</h3>

<p>The SciPy function <a href="https://docs.scipy.org/doc/scipy-0.7.x/reference/generated/scipy.stats.mstats.mquantiles.html">mquantiles</a>
implements the continues quantiles from the Hyndman-Fan list: Type 4-9.
This includes the interpolated quantile (Type 7), but not the empirical quantiles (Type 1,2).
So, as of this writing, there are no options for calculating empirical quantiles (Type 1,2) with SciPy’s mquantile function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="kn">import</span> <span class="n">mquantiles</span>
<span class="n">D</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">alphap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">betap</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c"># linear</span>
</code></pre></div></div>

<figure id="figure-6"><a href="/assets/f69174cb9ec030c4bed3b437.png"><img src="/assets/f69174cb9ec030c4bed3b437.png" alt="Quantiles as computed by the np.percentile function." /></a><figcaption>Figure 6: Quantiles as computed by the np.percentile function. [<a href="/assets/f69174cb9ec030c4bed3b437.png">PNG</a>]</figcaption></figure>

<h3 id="r">R</h3>
<p>According to the documentation the R <a href="https://www.rdocumentation.org/packages/stats/versions/3.6.0/topics/quantile">quantile function</a> implements quantiles of all 9 Hydman-Fan Types of Quantiles.
This includes empirical quantiles (Type 1,2) and interpolated quantiles (Type 4).</p>

<p>The full coverage of the Hydman-Fan list is less surprising, when one takes into account, that Hydman wrote the R quantile function himself:</p>

<blockquote>
  <p>I wrote a new quantile() function (with Ivan Frohne) which made it into R core v2.0 in October 2004. Everyone computing quantiles in R was now using our code and the paper was cited in the help file. – https://robjhyndman.com/hyndsight/sample-quantiles-20-years-later/</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<p>The definition of empirical quantiles is a literal translation of the probabilistic quantiles to the setting of discrete data-sets.
The definition of interpolated quantiles is natural form the implementation perspective.</p>

<p>As a sanity check both versions satisfy the desirable properties from our list.</p>

<p>Both quantiles are covered in the encyclopedic Hydman-Fan paper as Types 1,2 and Type 7 respectively.
So they can be regarded as well established.</p>

<p>One advantage of the interpolated quantile function is, that is continues,
whereas the empirical quantile function is piece-wise constant with discrete jumps.
This property makes the interpolated quantile more suitable for use in plotting applications like the QQ-plot.</p>

<p>One advantage of the empirical quantile is that it gives exact answers to the
practical problem of bounding ratios of samples above/below a threshold.
This feature makes empirical quantile more suitable for checking SLA/SLO bounds of e.g. latency distributions.</p>

<p>In many cases there is not much of a difference between both versions.
When samples are close together, so will be the quantiles in that area.
When samples are far apart, like in the long tail of a distribution, the differences can be very substantial.</p>

<p>Apparently most software products prefer to compute interpolated quantiles.
Somewhat shockingly for the author, support for empirical quantiles is often entirely lacking, 
at least in the popular Python libraries.</p>

<p><strong>Summary.</strong></p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Empirical Quantile</th>
      <th>Interpolated Quantile</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Motivation</td>
      <td>Probability Theory</td>
      <td>Implementation/Plotting</td>
    </tr>
    <tr>
      <td>Desirable Properties hold</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>Gives sample ratio bounds</td>
      <td>exactly</td>
      <td>approximately</td>
    </tr>
    <tr>
      <td>Continues in q</td>
      <td>no</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>Implementation available</td>
      <td>not everywhere</td>
      <td>widely</td>
    </tr>
  </tbody>
</table>

<h2 class="no_toc" id="references">References</h2>

<ul>
  <li>Hyndman, R. J. and Fan, Y. (1996) Sample quantiles in statistical packages, American Statistician 50, 361–365. 10.2307/2684934 <a href="https://robjhyndman.com/publications/quantiles/">robhyndman.com</a></li>
</ul>



  <br/>
  <em>View the version history of this post on <a href="https://github.com/HeinrichHartmann/HeinrichHartmann.github.io/commits/source/_posts/2019-10-04-Quantiles.md">GitHub</a>.</em>
  <br/>
  <!-- Comments -->
  
    <em>Comments have been disabled until the dust around the GDPR settled.</em>
    <!-- <div id="disqus_thread"></div> -->
    <!-- <script type="text/javascript"> -->
    <!--   /* * * CONFIGURATION VARIABLES * * */ -->
    <!--   var disqus_shortname = 'heinrichhartmann'; -->
    <!--   /* * * DON'T EDIT BELOW THIS LINE * * */ -->
    <!--   (function() { -->
    <!--   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; -->
    <!--   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; -->
    <!--   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); -->
    <!--   })(); -->
    <!-- </script> -->
    <!-- <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments</a></noscript> -->
  

</div>


  <div class="footer">
    <div class="contact">
      <p>
        Licensed under <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC-BY 4.0.</a>
        <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title" style="display:none">This blog</span>
        <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName" style="display:none">Heinrich Hartmann</span>
      </p>
    </div>
  </div>
</div>

<!-- Google Analytics -->

<!-- <script> -->
<!--   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ -->
<!--   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), -->
<!--   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) -->
<!--   })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); -->

<!--   ga('create', 'UA-53959000-1', 'auto'); -->
<!--   ga('send', 'pageview'); -->
<!-- </script> -->

</body>
</html>
